<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Barcode Scanner</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #000;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
    }

    #reader {
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    .scan-box {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 320px;
      height: 320px;
      transform: translate(-50%, -50%);
      border: 3px solid rgba(0, 255, 0, 0.5);
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
      z-index: 5;
      overflow: hidden;
    }

    .scan-line {
      position: absolute;
      width: 100%;
      height: 3px;
      background: linear-gradient(to right, #00ff00, #00cc99);
      animation: scan 2.5s infinite;
    }

    @keyframes scan {
      0% { top: 0%; }
      50% { top: 95%; }
      100% { top: 0%; }
    }

    .controls {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 10;
    }

    .btn {
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 15px;
      cursor: pointer;
      margin: 6px;
      transition: background 0.3s;
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    #result {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 500;
      color: #00ff99;
      max-width: 90%;
      word-wrap: break-word;
      z-index: 10;
      text-align: center;
    }

    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      background: rgba(0,0,0,0.7);
      padding: 12px 20px;
      border-radius: 10px;
      z-index: 1000;
      font-size: 16px;
      display: none;
    }
  </style>
</head>
<body>
  <div id="reader">
    <div class="scan-box">
      <div class="scan-line"></div>
    </div>
  </div>

  <div class="controls">
    <button class="btn" onclick="switchCamera()">ðŸ”„ Switch Camera</button>
  </div>

  <div id="result"></div>
  <div class="loading" id="loading">ðŸ“¸ Switching camera...</div>

  <script>
    let currentCamera = "environment";
    let scanner;

    async function startScanner() {
      scanner = new Html5Qrcode("reader");
      try {
        const devices = await Html5Qrcode.getCameras();
        if (!devices || devices.length === 0) {
          alert("ðŸš« No camera devices found.");
          return;
        }

        const config = {
          fps: 25,
          qrbox: { width: 320, height: 320 },
          formatsToSupport: [
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.UPC_A
          ],
          experimentalFeatures: {
            useBarCodeDetectorIfSupported: true
          }
        };

        await scanner.start(
          { facingMode: currentCamera },
          config,
          onScanSuccess,
          onScanFailure
        );

      } catch (err) {
        alert("Camera error:\n" + (err.message || err));
        console.error("Camera error:", err);
      }
    }

    function onScanSuccess(decodedText) {
      document.getElementById("result").innerText = `âœ… Scanned: ${decodedText}`;
      if (navigator.vibrate) navigator.vibrate(100);
      scanner.pause();
      const deepLink = `exp://192.168.1.7:8081/--/Cart?barcode=${encodeURIComponent(decodedText)}`;
      window.location.href = deepLink;
    }

    function onScanFailure(_) {
      // silent fail
    }

    async function switchCamera() {
      try {
        document.getElementById("loading").style.display = "block";
        if (scanner) {
          await scanner.stop();
          await scanner.clear();
        }
        currentCamera = currentCamera === "environment" ? "user" : "environment";
        await startScanner();
      } catch (err) {
        alert("Camera switch error:\n" + (err.message || err));
      } finally {
        document.getElementById("loading").style.display = "none";
      }
    }

    startScanner();
  </script>
</body>
</html>
