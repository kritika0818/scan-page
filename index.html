<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Smart Barcode Scanner</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: #000;
        font-family: 'Segoe UI', sans-serif;
        overflow: hidden;
      }

      #reader {
        width: 100vw;
        height: 100vh;
        position: relative;
      }

      .scan-box {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 300px;
        height: 300px;
        transform: translate(-50%, -50%);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.15);
        z-index: 5;
        overflow: hidden;
      }

      .scan-line {
        position: absolute;
        width: 100%;
        height: 2px;
        background: lime;
        animation: scan 2s infinite;
      }

      @keyframes scan {
        0% { top: 0%; }
        50% { top: 95%; }
        100% { top: 0%; }
      }

      .controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
      }

      .btn {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: none;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        margin: 4px;
      }

      #result {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 16px;
        color: #00ff99;
        max-width: 90%;
        word-wrap: break-word;
        z-index: 10;
        text-align: center;
      }

      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        background: rgba(0,0,0,0.7);
        padding: 10px 20px;
        border-radius: 8px;
        z-index: 1000;
        font-size: 16px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="reader">
      <div class="scan-box">
        <div class="scan-line"></div>
      </div>
    </div>
    <div class="controls">
      <button class="btn" onclick="switchCamera()">ðŸ”„ Switch Camera</button>
    </div>
    <div id="result"></div>
    <div class="loading" id="loading">ðŸ“¸ Switching camera...</div>

    <script>
      let currentCamera = 'environment';
      let scanner;

      async function startScanner() {
        scanner = new Html5Qrcode("reader");
        try {
          await scanner.start(
            { facingMode: currentCamera },
            {
              fps: 30,
              qrbox: { width: 300, height: 300 },
              aspectRatio: 1.777,
              experimentalFeatures: {
                useBarCodeDetectorIfSupported: true
              }
            },
            onScanSuccess,
            onScanFailure
          );
        } catch (err) {
          alert("Camera error:\n" + err.message);
        }
      }

      function onScanSuccess(decodedText) {
        document.getElementById("result").innerText = `âœ… Scanned: ${decodedText}`;
        if (navigator.vibrate) navigator.vibrate(100);
        scanner.pause();

        if (decodedText.startsWith("exp://")) {
  window.location.href = decodedText;
} else if (isValidUrl(decodedText)) {
  if (confirm("Open this link?\n" + decodedText)) {
    window.location.href = decodedText;
  } else {
    scanner.resume();
  }
}

      }

      function onScanFailure(error) {
        // silent error
      }

      function isValidUrl(str) {
        try {
          new URL(str);
          return true;
        } catch (_) {
          return false;
        }
      }

      async function switchCamera() {
        try {
          document.getElementById("loading").style.display = "block";
          if (scanner) {
            await scanner.stop();
            await scanner.clear();
          }
          currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
          await startScanner();
        } catch (err) {
          alert("Failed to switch camera:\n" + err.message);
        } finally {
          document.getElementById("loading").style.display = "none";
        }
      }

      startScanner();
    </script>
  </body>
</html>
